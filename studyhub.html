<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub - Universal Learning Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
        }

        /* ===== NAVIGATION ===== */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-tab.active { background: var(--accent); border-color: var(--accent); color: white; }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ===== VIEWS ===== */
        .view { display: none; }
        .view.active { display: block; }

        /* ===== COURSE LIST ===== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .course-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            border-color: var(--accent);
        }

        .course-card.add-new {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            color: var(--text-muted);
        }

        .course-card.add-new:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .add-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

        .course-icon { font-size: 2.5rem; margin-bottom: 1rem; }

        .course-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .course-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .course-progress {
            margin-top: 1rem;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }

        .course-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #a855f7);
            transition: width 0.3s;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title { font-size: 1.25rem; font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body { padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--accent);
        }

        .form-textarea { min-height: 150px; resize: vertical; font-family: 'JetBrains Mono', monospace; }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .icon-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-option:hover { border-color: var(--text-muted); }
        .icon-option.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.2); }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px var(--accent-glow); }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-card); color: var(--text-primary); }

        .btn-danger { background: var(--error); color: white; }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }

        /* ===== COURSE DETAIL VIEW ===== */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            padding: 0.5rem 0;
        }

        .back-btn:hover { color: var(--accent); }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .course-header-left {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .course-header-icon {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 16px;
        }

        .course-header-info h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
        .course-header-info p { color: var(--text-secondary); }

        .course-actions { display: flex; gap: 0.75rem; }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab:hover { color: var(--text-secondary); }

        .tab.active {
            color: var(--accent);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== DIRECTION/GROUP LIST ===== */
        .direction-list { display: flex; flex-direction: column; gap: 1rem; }

        .direction-item {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .direction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .direction-header:hover { background: var(--bg-secondary); }

        .direction-info { display: flex; align-items: center; gap: 1rem; }

        .direction-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .direction-name { font-weight: 600; }

        .direction-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .direction-actions { display: flex; gap: 0.5rem; }

        .direction-body {
            display: none;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .direction-body.show { display: block; }

        .card-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .card-question {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 1rem;
        }

        .card-type {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .card-type.qa { background: rgba(99, 102, 241, 0.2); color: var(--accent); }
        .card-type.code { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .card-type.fill { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        /* ===== STUDY VIEW ===== */
        .study-container { max-width: 800px; margin: 0 auto; }

        .study-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .study-progress-bar {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .study-progress-item {
            padding: 0.4rem 0.8rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .study-progress-item.completed { border-color: var(--success); color: var(--success); }
        .study-progress-item.active { border-color: var(--accent); color: var(--accent); }
        .study-progress-item.locked { opacity: 0.5; }

        .study-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .study-card.correct { border-color: var(--success); }
        .study-card.incorrect { border-color: var(--error); animation: shake 0.4s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .study-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .study-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .study-timer.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .study-timer.danger { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        .study-direction-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
            border-radius: 6px;
            font-weight: 600;
        }

        .study-question {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .study-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            outline: none;
            resize: vertical;
            min-height: 100px;
        }

        .study-input:focus { border-color: var(--accent); }

        .code-editor {
            background: #1e1e2e;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #181825;
            border-bottom: 1px solid var(--border);
        }

        .code-language {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .code-editor textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            background: transparent;
            border: none;
            color: #cdd6f4;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            outline: none;
            resize: vertical;
        }

        .code-output {
            margin-top: 1rem;
            padding: 1rem;
            background: #181825;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .code-output.success { border-left: 3px solid var(--success); }
        .code-output.error { border-left: 3px solid var(--error); }

        .study-button-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .study-feedback {
            margin-top: 1.25rem;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            display: none;
        }

        .study-feedback.show { display: block; }

        .study-feedback.correct {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .study-feedback.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .feedback-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        .study-feedback.correct .feedback-label { color: var(--success); }
        .study-feedback.incorrect .feedback-label { color: var(--error); }

        .expected-answer {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
        }

        /* ===== IMPORT VIEW ===== */
        .import-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
        }

        .import-area:hover, .import-area.dragover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .import-icon { font-size: 3rem; margin-bottom: 1rem; }

        .format-examples {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .format-example {
            margin-bottom: 1.5rem;
        }

        .format-example:last-child { margin-bottom: 0; }

        .format-example h4 {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .format-example pre {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--error); color: var(--error); }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        @media (max-width: 768px) {
            .navbar { padding: 1rem; flex-direction: column; gap: 1rem; }
            .container { padding: 1rem; }
            .course-header { flex-direction: column; gap: 1rem; }
            .course-header-left { flex-direction: column; text-align: center; }
            .course-actions { width: 100%; }
            .course-actions .btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="logo">üìö StudyHub</div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-view="courses">Courses</button>
            <button class="nav-tab" data-view="import">Import</button>
            <button class="nav-tab" data-view="stats">Stats</button>
        </div>
    </nav>

    <div class="container">
        <!-- COURSES VIEW -->
        <div class="view active" id="view-courses">
            <div class="page-header">
                <h1 class="page-title">My Courses</h1>
            </div>
            <div class="course-grid" id="course-grid"></div>
        </div>

        <!-- COURSE DETAIL VIEW -->
        <div class="view" id="view-course-detail">
            <div class="back-btn" onclick="showView('courses')">‚Üê Back to Courses</div>
            <div id="course-detail-content"></div>
        </div>

        <!-- STUDY VIEW -->
        <div class="view" id="view-study">
            <div class="study-container" id="study-container"></div>
        </div>

        <!-- IMPORT VIEW -->
        <div class="view" id="view-import">
            <div class="page-header">
                <h1 class="page-title">Import Knowledge</h1>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Course</label>
                <select class="form-select" id="import-course-select">
                    <option value="">-- Select a course --</option>
                </select>
            </div>

            <div class="import-area" id="import-area">
                <div class="import-icon">üìÑ</div>
                <h3>Paste or Drop Your Content</h3>
                <p style="color: var(--text-muted); margin-top: 0.5rem;">Supports multiple formats</p>
            </div>

            <textarea class="form-textarea" id="import-textarea" placeholder="Paste your content here..."></textarea>

            <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                <button class="btn btn-primary" onclick="parseAndImport()">üîç Parse & Preview</button>
                <button class="btn btn-secondary" onclick="clearImport()">Clear</button>
            </div>

            <div id="import-preview" style="margin-top: 1.5rem;"></div>

            <div class="format-examples">
                <h3 style="margin-bottom: 1rem;">üìù Supported Formats</h3>
                
                <div class="format-example">
                    <h4>Format 1: Simple Q&A (Tab or Colon separated)</h4>
                    <pre>Question 1:	Answer 1
Question 2:	Answer 2
#direction: Chapter Name
Question 3:	Answer 3</pre>
                </div>

                <div class="format-example">
                    <h4>Format 2: Markdown-style with Headers</h4>
                    <pre># Direction 1: Data Protection
- Q: What are the 7 principles?
- A: Lawfulness, Purpose limitation...

# Direction 2: Online Safety
- Q: What are platform duties?
- A: Risk assessment, Content moderation...</pre>
                </div>

                <div class="format-example">
                    <h4>Format 3: JSON</h4>
                    <pre>{
  "directions": [
    {
      "name": "Chapter 1",
      "cards": [
        {"q": "Question?", "a": "Answer", "type": "qa"},
        {"q": "Write code to...", "a": "console.log('hi')", "type": "code", "lang": "javascript"}
      ]
    }
  ]
}</pre>
                </div>

                <div class="format-example">
                    <h4>Format 4: Code Questions</h4>
                    <pre>#type: code
#lang: python
Q: Write a function to calculate factorial
A: def factorial(n):
    return 1 if n <= 1 else n * factorial(n-1)</pre>
                </div>
            </div>
        </div>

        <!-- STATS VIEW -->
        <div class="view" id="view-stats">
            <div class="page-header">
                <h1 class="page-title">Statistics</h1>
            </div>
            <div id="stats-content"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="modal-course">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-course-title">New Course</h3>
                <button class="modal-close" onclick="closeModal('modal-course')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Course Name</label>
                    <input type="text" class="form-input" id="course-name-input" placeholder="e.g., Professional Skills & Issues">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <div class="icon-picker" id="icon-picker"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <input type="text" class="form-input" id="course-desc-input" placeholder="Brief description">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-course')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCourse()">Save Course</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-direction">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Direction / Chapter</h3>
                <button class="modal-close" onclick="closeModal('modal-direction')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Direction Name</label>
                    <input type="text" class="form-input" id="direction-name-input" placeholder="e.g., Data Protection">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <div class="icon-picker" id="direction-icon-picker"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-direction')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDirection()">Add Direction</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-card">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Card</h3>
                <button class="modal-close" onclick="closeModal('modal-card')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Card Type</label>
                    <select class="form-select" id="card-type-select">
                        <option value="qa">Q&A (Question & Answer)</option>
                        <option value="code">Code (Programming)</option>
                        <option value="fill">Fill in the Blank</option>
                    </select>
                </div>
                <div class="form-group" id="card-lang-group" style="display: none;">
                    <label class="form-label">Programming Language</label>
                    <select class="form-select" id="card-lang-select">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="sql">SQL</option>
                        <option value="html">HTML/CSS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Question / Prompt</label>
                    <textarea class="form-textarea" id="card-question-input" style="min-height: 80px;" placeholder="Enter your question..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Answer / Expected Code</label>
                    <textarea class="form-textarea" id="card-answer-input" placeholder="Enter the answer..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-card')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCard()">Add Card</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== STORAGE ==========
        const STORAGE_KEY = 'studyhub-data';
        const ICONS = ['üìö', 'üíª', 'üß†', '‚öñÔ∏è', 'üîí', 'üåê', 'üìä', 'üéØ', '‚ö°', 'üî¨', 'üìê', 'üé®', 'üèõÔ∏è', 'üíº', 'üîß', 'üìù', 'üéì', 'üåç', 'üß¨', 'üìà'];

        let appData = {
            courses: [],
            currentCourseId: null,
            currentDirectionId: null
        };

        function loadAppData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    appData = JSON.parse(saved);
                }
            } catch (e) {}
        }

        function saveAppData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // ========== NAVIGATION ==========
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.querySelector(`.nav-tab[data-view="${viewId}"]`)?.classList.add('active');

            if (viewId === 'courses') renderCourseGrid();
            if (viewId === 'import') updateImportCourseSelect();
            if (viewId === 'stats') renderStats();
        }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => showView(tab.dataset.view));
        });

        // ========== MODALS ==========
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ========== TOAST ==========
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 2500);
        }

        // ========== COURSE MANAGEMENT ==========
        function renderCourseGrid() {
            const grid = document.getElementById('course-grid');
            
            const coursesHtml = appData.courses.map(course => {
                const totalCards = course.directions.reduce((sum, d) => sum + d.cards.length, 0);
                const stats = course.stats || { correct: 0, attempts: 0 };
                const progress = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                
                return `
                    <div class="course-card" onclick="openCourse('${course.id}')">
                        <div class="course-icon">${course.icon}</div>
                        <div class="course-name">${course.name}</div>
                        <div class="course-stats">${course.directions.length} directions ¬∑ ${totalCards} cards</div>
                        <div class="course-progress">
                            <div class="course-progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = coursesHtml + `
                <div class="course-card add-new" onclick="openNewCourseModal()">
                    <div class="add-icon">+</div>
                    <div>Add New Course</div>
                </div>
            `;
        }

        function openNewCourseModal() {
            document.getElementById('modal-course-title').textContent = 'New Course';
            document.getElementById('course-name-input').value = '';
            document.getElementById('course-desc-input').value = '';
            
            renderIconPicker('icon-picker');
            appData.editingCourseId = null;
            openModal('modal-course');
        }

        function renderIconPicker(containerId, selected = 'üìö') {
            const container = document.getElementById(containerId);
            container.innerHTML = ICONS.map(icon => `
                <div class="icon-option ${icon === selected ? 'selected' : ''}" data-icon="${icon}">${icon}</div>
            `).join('');
            
            container.querySelectorAll('.icon-option').forEach(opt => {
                opt.onclick = () => {
                    container.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                };
            });
        }

        function saveCourse() {
            const name = document.getElementById('course-name-input').value.trim();
            const desc = document.getElementById('course-desc-input').value.trim();
            const icon = document.querySelector('#icon-picker .icon-option.selected')?.dataset.icon || 'üìö';

            if (!name) {
                showToast('Please enter a course name', 'error');
                return;
            }

            if (appData.editingCourseId) {
                const course = appData.courses.find(c => c.id === appData.editingCourseId);
                if (course) {
                    course.name = name;
                    course.description = desc;
                    course.icon = icon;
                }
            } else {
                const newCourse = {
                    id: 'course_' + Date.now(),
                    name,
                    description: desc,
                    icon,
                    directions: [],
                    stats: { correct: 0, wrong: 0, attempts: 0 },
                    createdAt: new Date().toISOString()
                };
                appData.courses.push(newCourse);
            }

            saveAppData();
            closeModal('modal-course');
            renderCourseGrid();
            showToast('Course saved!', 'success');
        }

        function openCourse(courseId) {
            appData.currentCourseId = courseId;
            const course = appData.courses.find(c => c.id === courseId);
            if (!course) return;

            renderCourseDetail(course);
            showView('course-detail');
        }

        function renderCourseDetail(course) {
            const container = document.getElementById('course-detail-content');
            const totalCards = course.directions.reduce((sum, d) => sum + d.cards.length, 0);
            
            container.innerHTML = `
                <div class="course-header">
                    <div class="course-header-left">
                        <div class="course-header-icon">${course.icon}</div>
                        <div class="course-header-info">
                            <h1>${course.name}</h1>
                            <p>${course.directions.length} directions ¬∑ ${totalCards} cards</p>
                        </div>
                    </div>
                    <div class="course-actions">
                        <button class="btn btn-primary" onclick="startStudy('${course.id}')">‚ñ∂ Start Study</button>
                        <button class="btn btn-secondary" onclick="editCourse('${course.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">üóëÔ∏è</button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="directions">Directions</button>
                    <button class="tab" data-tab="all-cards">All Cards</button>
                    <button class="tab" data-tab="course-stats">Statistics</button>
                </div>

                <div class="tab-content active" id="tab-directions">
                    <button class="btn btn-secondary" onclick="openNewDirectionModal()" style="margin-bottom: 1rem;">+ Add Direction</button>
                    <div class="direction-list" id="direction-list">
                        ${renderDirectionList(course)}
                    </div>
                </div>

                <div class="tab-content" id="tab-all-cards">
                    <div class="card-list">
                        ${course.directions.flatMap(d => d.cards.map(c => `
                            <div class="card-item">
                                <span class="card-question">${c.q}</span>
                                <span class="card-type ${c.type || 'qa'}">${c.type || 'qa'}</span>
                            </div>
                        `)).join('') || '<div class="empty-state"><div class="empty-state-icon">üì≠</div>No cards yet</div>'}
                    </div>
                </div>

                <div class="tab-content" id="tab-course-stats">
                    ${renderCourseStats(course)}
                </div>
            `;

            // Tab switching
            container.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                };
            });
        }

        function renderDirectionList(course) {
            if (course.directions.length === 0) {
                return '<div class="empty-state"><div class="empty-state-icon">üìÇ</div>No directions yet. Add one to get started!</div>';
            }

            return course.directions.map((dir, idx) => `
                <div class="direction-item">
                    <div class="direction-header" onclick="toggleDirection('${dir.id}')">
                        <div class="direction-info">
                            <div class="direction-icon">${dir.icon || 'üìÅ'}</div>
                            <div>
                                <div class="direction-name">${dir.name}</div>
                                <div class="direction-meta">${dir.cards.length} cards</div>
                            </div>
                        </div>
                        <div class="direction-actions">
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openAddCardModal('${dir.id}')">+ Card</button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); deleteDirection('${dir.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="direction-body" id="direction-body-${dir.id}">
                        <div class="card-list">
                            ${dir.cards.map((card, cIdx) => `
                                <div class="card-item">
                                    <span class="card-question">${card.q}</span>
                                    <span class="card-type ${card.type || 'qa'}">${card.type || 'qa'}</span>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteCard('${dir.id}', ${cIdx})">√ó</button>
                                </div>
                            `).join('') || '<p style="color: var(--text-muted);">No cards in this direction</p>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDirection(dirId) {
            const body = document.getElementById(`direction-body-${dirId}`);
            body.classList.toggle('show');
        }

        function renderCourseStats(course) {
            const stats = course.stats || { correct: 0, wrong: 0, attempts: 0 };
            const accuracy = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">${stats.attempts}</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Total Attempts</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${stats.correct}</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Correct</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);">${accuracy}%</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Accuracy</div>
                    </div>
                </div>
            `;
        }

        // ========== DIRECTION MANAGEMENT ==========
        function openNewDirectionModal() {
            document.getElementById('direction-name-input').value = '';
            renderIconPicker('direction-icon-picker', 'üìÅ');
            openModal('modal-direction');
        }

        function saveDirection() {
            const name = document.getElementById('direction-name-input').value.trim();
            const icon = document.querySelector('#direction-icon-picker .icon-option.selected')?.dataset.icon || 'üìÅ';

            if (!name) {
                showToast('Please enter a direction name', 'error');
                return;
            }

            const course = appData.courses.find(c => c.id === appData.currentCourseId);
            if (!course) return;

            course.directions.push({
                id: 'dir_' + Date.now(),
                name,
                icon,
                cards: [],
                stats: { correct: 0, wrong: 0, resets: 0, completions: 0 }
            });

            saveAppData();
            closeModal('modal-direction');
            renderCourseDetail(course);
            showToast('Direction added!', 'success');
        }

        function deleteDirection(dirId) {
            if (!confirm('Delete this direction and all its cards?')) return;
            
            const course = appData.courses.find(c => c.id === appData.currentCourseId);
            if (!course) return;

            course.directions = course.directions.filter(d => d.id !== dirId);
            saveAppData();
            renderCourseDetail(course);
            showToast('Direction deleted', 'success');
        }

        // ========== CARD MANAGEMENT ==========
        function openAddCardModal(dirId) {
            appData.currentDirectionId = dirId;
            document.getElementById('card-type-select').value = 'qa';
            document.getElementById('card-question-input').value = '';
            document.getElementById('card-answer-input').value = '';
            document.getElementById('card-lang-group').style.display = 'none';
            openModal('modal-card');
        }

        document.getElementById('card-type-select').addEventListener('change', (e) => {
            document.getElementById('card-lang-group').style.display = e.target.value === 'code' ? 'block' : 'none';
        });

        function saveCard() {
            const type = document.getElementById('card-type-select').value;
            const question = document.getElementById('card-question-input').value.trim();
            const answer = document.getElementById('card-answer-input').value.trim();
            const lang = document.getElementById('card-lang-select').value;

            if (!question || !answer) {
                showToast('Please fill in both fields', 'error');
                return;
            }

            const course = appData.courses.find(c => c.id === appData.currentCourseId);
            const direction = course?.directions.find(d => d.id === appData.currentDirectionId);
            if (!direction) return;

            const card = { q: question, a: answer, type };
            if (type === 'code') card.lang = lang;

            direction.cards.push(card);
            saveAppData();
            closeModal('modal-card');
            renderCourseDetail(course);
            showToast('Card added!', 'success');
        }

        function deleteCard(dirId, cardIdx) {
            const course = appData.courses.find(c => c.id === appData.currentCourseId);
            const direction = course?.directions.find(d => d.id === dirId);
            if (!direction) return;

            direction.cards.splice(cardIdx, 1);
            saveAppData();
            renderCourseDetail(course);
        }

        function deleteCourse(courseId) {
            if (!confirm('Delete this course and all its content?')) return;
            
            appData.courses = appData.courses.filter(c => c.id !== courseId);
            saveAppData();
            showView('courses');
            showToast('Course deleted', 'success');
        }

        function editCourse(courseId) {
            const course = appData.courses.find(c => c.id === courseId);
            if (!course) return;

            document.getElementById('modal-course-title').textContent = 'Edit Course';
            document.getElementById('course-name-input').value = course.name;
            document.getElementById('course-desc-input').value = course.description || '';
            renderIconPicker('icon-picker', course.icon);
            appData.editingCourseId = courseId;
            openModal('modal-course');
        }

        // ========== IMPORT ==========
        function updateImportCourseSelect() {
            const select = document.getElementById('import-course-select');
            select.innerHTML = '<option value="">-- Select a course --</option>' +
                appData.courses.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
        }

        function parseAndImport() {
            const courseId = document.getElementById('import-course-select').value;
            const text = document.getElementById('import-textarea').value.trim();

            if (!courseId) {
                showToast('Please select a course first', 'error');
                return;
            }

            if (!text) {
                showToast('Please paste some content', 'error');
                return;
            }

            // Try JSON first
            try {
                const json = JSON.parse(text);
                if (json.directions) {
                    importJSON(courseId, json);
                    return;
                }
            } catch (e) {}

            // Parse text format
            const parsed = parseTextFormat(text);
            previewImport(courseId, parsed);
        }

        function parseTextFormat(text) {
            const lines = text.split('\n');
            const directions = [];
            let currentDirection = { name: 'Default', icon: 'üìÅ', cards: [] };
            let currentType = 'qa';
            let currentLang = 'javascript';

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Check for direction header
                if (line.startsWith('# ') || line.startsWith('#direction:')) {
                    if (currentDirection.cards.length > 0) {
                        directions.push(currentDirection);
                    }
                    const name = line.replace(/^#\s*(direction:)?\s*/i, '').trim();
                    currentDirection = { name, icon: 'üìÅ', cards: [] };
                    continue;
                }

                // Check for type/lang settings
                if (line.startsWith('#type:')) {
                    currentType = line.replace('#type:', '').trim();
                    continue;
                }
                if (line.startsWith('#lang:')) {
                    currentLang = line.replace('#lang:', '').trim();
                    continue;
                }

                // Parse Q&A
                let q = '', a = '';
                
                // Format: Q: ... / A: ...
                if (line.startsWith('- Q:') || line.startsWith('Q:')) {
                    q = line.replace(/^-?\s*Q:\s*/, '').trim();
                    continue;
                }
                if (line.startsWith('- A:') || line.startsWith('A:')) {
                    a = line.replace(/^-?\s*A:\s*/, '').trim();
                    if (currentDirection.cards.length > 0) {
                        const lastCard = currentDirection.cards[currentDirection.cards.length - 1];
                        if (!lastCard.a) {
                            lastCard.a = a;
                            continue;
                        }
                    }
                }

                // Format: Question TAB Answer or Question: Answer
                const tabSplit = line.split('\t');
                if (tabSplit.length >= 2) {
                    q = tabSplit[0].trim();
                    a = tabSplit.slice(1).join('\t').trim();
                } else {
                    const colonMatch = line.match(/^(.+?):\s*(.+)$/);
                    if (colonMatch) {
                        q = colonMatch[1].trim();
                        a = colonMatch[2].trim();
                    }
                }

                if (q && a) {
                    const card = { q, a, type: currentType };
                    if (currentType === 'code') card.lang = currentLang;
                    currentDirection.cards.push(card);
                } else if (q) {
                    currentDirection.cards.push({ q, a: '', type: currentType });
                }
            }

            if (currentDirection.cards.length > 0) {
                directions.push(currentDirection);
            }

            return directions;
        }

        function previewImport(courseId, parsed) {
            const preview = document.getElementById('import-preview');
            const totalCards = parsed.reduce((sum, d) => sum + d.cards.length, 0);

            preview.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem;">üìã Preview: ${parsed.length} directions, ${totalCards} cards</h3>
                    ${parsed.map(dir => `
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <strong>${dir.name}</strong> (${dir.cards.length} cards)
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                                ${dir.cards.slice(0, 3).map(c => `‚Ä¢ ${c.q.substring(0, 50)}...`).join('<br>')}
                                ${dir.cards.length > 3 ? `<br>... and ${dir.cards.length - 3} more` : ''}
                            </div>
                        </div>
                    `).join('')}
                    <button class="btn btn-primary" onclick="confirmImport('${courseId}')">‚úì Confirm Import</button>
                </div>
            `;

            appData.pendingImport = parsed;
        }

        function confirmImport(courseId) {
            const course = appData.courses.find(c => c.id === courseId);
            if (!course || !appData.pendingImport) return;

            for (const dir of appData.pendingImport) {
                const existing = course.directions.find(d => d.name === dir.name);
                if (existing) {
                    existing.cards.push(...dir.cards);
                } else {
                    course.directions.push({
                        id: 'dir_' + Date.now() + Math.random(),
                        name: dir.name,
                        icon: dir.icon || 'üìÅ',
                        cards: dir.cards,
                        stats: { correct: 0, wrong: 0, resets: 0, completions: 0 }
                    });
                }
            }

            saveAppData();
            document.getElementById('import-textarea').value = '';
            document.getElementById('import-preview').innerHTML = '';
            appData.pendingImport = null;
            showToast(`Imported successfully!`, 'success');
        }

        function importJSON(courseId, json) {
            appData.pendingImport = json.directions;
            previewImport(courseId, json.directions);
        }

        function clearImport() {
            document.getElementById('import-textarea').value = '';
            document.getElementById('import-preview').innerHTML = '';
        }

        // ========== STUDY MODE ==========
        let studyState = {
            course: null,
            directionOrder: [],
            currentDirIndex: 0,
            remainingCards: [],
            currentCard: null,
            round: 1,
            timerInterval: null,
            timeRemaining: 0,
            isChecked: false
        };

        function startStudy(courseId) {
            const course = appData.courses.find(c => c.id === courseId);
            if (!course || course.directions.length === 0) {
                showToast('No directions to study!', 'error');
                return;
            }

            const totalCards = course.directions.reduce((sum, d) => sum + d.cards.length, 0);
            if (totalCards === 0) {
                showToast('No cards to study!', 'error');
                return;
            }

            studyState.course = course;
            studyState.directionOrder = course.directions.map((_, i) => i);
            studyState.currentDirIndex = 0;
            studyState.round = 1;
            studyState.isChecked = false;

            loadStudyDirection(0);
            showView('study');
            renderStudyCard();
        }

        function loadStudyDirection(dirIndex) {
            const dir = studyState.course.directions[studyState.directionOrder[dirIndex]];
            studyState.remainingCards = dir.cards.map((card, idx) => ({
                ...card,
                originalIndex: idx,
                directionIndex: studyState.directionOrder[dirIndex]
            }));
            shuffleArray(studyState.remainingCards);
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function renderStudyCard() {
            if (studyState.remainingCards.length === 0) {
                completeStudyDirection();
                return;
            }

            studyState.currentCard = studyState.remainingCards[0];
            studyState.isChecked = false;

            const dir = studyState.course.directions[studyState.currentCard.directionIndex];
            const card = studyState.currentCard;
            const wordCount = card.a.split(/\s+/).length;
            const timeLimit = wordCount <= 15 ? 30 : 60;

            const container = document.getElementById('study-container');
            container.innerHTML = `
                <div class="study-header">
                    <div class="study-progress-bar">
                        ${studyState.directionOrder.map((dIdx, i) => {
                            const d = studyState.course.directions[dIdx];
                            let status = 'locked';
                            if (i < studyState.currentDirIndex) status = 'completed';
                            else if (i === studyState.currentDirIndex) status = 'active';
                            return `<div class="study-progress-item ${status}">${d.icon || 'üìÅ'} D${i + 1}</div>`;
                        }).join('')}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                        Round ${studyState.round} ¬∑ ${studyState.course.directions[studyState.currentCard.directionIndex].cards.length - studyState.remainingCards.length}/${studyState.course.directions[studyState.currentCard.directionIndex].cards.length} in direction
                    </div>
                </div>

                <div class="study-card" id="study-card">
                    <div class="study-question-header">
                        <span class="study-direction-tag">${dir.icon || 'üìÅ'} ${dir.name}</span>
                        <div class="study-timer" id="study-timer">
                            <span id="timer-text">${timeLimit}s</span>
                        </div>
                    </div>

                    <div class="study-question">${card.q}</div>

                    ${card.type === 'code' ? `
                        <div class="code-editor">
                            <div class="code-editor-header">
                                <span class="code-language">${card.lang || 'javascript'}</span>
                            </div>
                            <textarea id="study-input" placeholder="Write your code here..."></textarea>
                        </div>
                    ` : `
                        <textarea class="study-input" id="study-input" placeholder="Type your answer..."></textarea>
                    `}

                    <div class="study-button-row">
                        <button class="btn btn-secondary" id="show-btn" onclick="showStudyAnswer()">üëÅ Show</button>
                        <button class="btn btn-primary" id="check-btn" onclick="checkStudyAnswer()">‚úì Check</button>
                    </div>

                    <div class="study-feedback" id="study-feedback">
                        <span class="feedback-label"></span>
                        <div class="expected-answer" id="expected-answer"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary btn-sm" onclick="showView('course-detail'); openCourse('${studyState.course.id}');">Exit Study</button>
                </div>
            `;

            startStudyTimer(timeLimit);
            setTimeout(() => document.getElementById('study-input')?.focus(), 50);
        }

        function startStudyTimer(seconds) {
            studyState.timeRemaining = seconds;
            clearInterval(studyState.timerInterval);
            
            studyState.timerInterval = setInterval(() => {
                studyState.timeRemaining--;
                const timerEl = document.getElementById('study-timer');
                const timerText = document.getElementById('timer-text');
                
                if (timerText) timerText.textContent = `${studyState.timeRemaining}s`;
                
                const ratio = studyState.timeRemaining / seconds;
                if (timerEl) {
                    timerEl.classList.remove('warning', 'danger');
                    if (ratio <= 0.25) timerEl.classList.add('danger');
                    else if (ratio <= 0.5) timerEl.classList.add('warning');
                }

                if (studyState.timeRemaining <= 0) {
                    clearInterval(studyState.timerInterval);
                    handleStudyTimeout();
                }
            }, 1000);
        }

        function handleStudyTimeout() {
            if (studyState.isChecked) return;
            showStudyFeedback('incorrect', '‚è± Time\'s up!', true);
        }

        function normalizeAnswer(str) {
            return str.toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        function checkStudyAnswer() {
            if (studyState.isChecked) {
                renderStudyCard();
                return;
            }

            clearInterval(studyState.timerInterval);

            const userAnswer = normalizeAnswer(document.getElementById('study-input').value);
            const correctAnswer = normalizeAnswer(studyState.currentCard.a);

            const correctWords = correctAnswer.split(' ').filter(w => w.length > 2);
            const userWords = userAnswer.split(' ').filter(w => w.length > 2);

            let matchCount = 0;
            correctWords.forEach(word => {
                if (userWords.some(uw => uw.includes(word) || word.includes(uw))) {
                    matchCount++;
                }
            });

            const similarity = correctWords.length > 0 ? matchCount / correctWords.length : 0;
            const isCorrect = similarity >= 0.6 || userAnswer === correctAnswer;

            // Update stats
            studyState.course.stats = studyState.course.stats || { correct: 0, wrong: 0, attempts: 0 };
            studyState.course.stats.attempts++;

            if (isCorrect) {
                studyState.course.stats.correct++;
                studyState.remainingCards.shift();
                showStudyFeedback('correct', '‚úì Correct!', false);
            } else {
                studyState.course.stats.wrong++;
                showStudyFeedback('incorrect', '‚úó Wrong - Direction reset!', true);
            }

            saveAppData();
        }

        function showStudyAnswer() {
            clearInterval(studyState.timerInterval);
            studyState.course.stats = studyState.course.stats || { correct: 0, wrong: 0, attempts: 0 };
            studyState.course.stats.attempts++;
            studyState.course.stats.wrong++;
            saveAppData();
            showStudyFeedback('incorrect', 'üìñ Answer shown - Direction reset!', true);
        }

        function showStudyFeedback(type, label, needsReset) {
            studyState.isChecked = true;

            const card = document.getElementById('study-card');
            const feedback = document.getElementById('study-feedback');
            const checkBtn = document.getElementById('check-btn');
            const showBtn = document.getElementById('show-btn');

            card.className = `study-card ${type}`;
            feedback.className = `study-feedback show ${type}`;
            feedback.querySelector('.feedback-label').textContent = label;
            document.getElementById('expected-answer').textContent = studyState.currentCard.a;

            checkBtn.textContent = 'Next ‚Üí';
            showBtn.style.display = 'none';
            document.getElementById('study-input').disabled = true;

            if (needsReset) {
                loadStudyDirection(studyState.currentDirIndex);
            }
        }

        function completeStudyDirection() {
            clearInterval(studyState.timerInterval);
            showToast(`‚úÖ Direction completed!`, 'success');

            studyState.currentDirIndex++;

            if (studyState.currentDirIndex >= studyState.course.directions.length) {
                studyState.round++;
                studyState.currentDirIndex = 0;
                shuffleArray(studyState.directionOrder);
                showToast(`üéâ Round complete! Starting round ${studyState.round}`, 'success');
            }

            loadStudyDirection(studyState.currentDirIndex);
            setTimeout(() => renderStudyCard(), 500);
        }

        // ========== STATS VIEW ==========
        function renderStats() {
            const container = document.getElementById('stats-content');
            
            if (appData.courses.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div>No courses yet</div>';
                return;
            }

            let totalAttempts = 0, totalCorrect = 0, totalCards = 0;
            appData.courses.forEach(c => {
                const stats = c.stats || { attempts: 0, correct: 0 };
                totalAttempts += stats.attempts;
                totalCorrect += stats.correct;
                totalCards += c.directions.reduce((sum, d) => sum + d.cards.length, 0);
            });

            const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);">${appData.courses.length}</div>
                        <div style="color: var(--text-muted);">Courses</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--success);">${totalCards}</div>
                        <div style="color: var(--text-muted);">Total Cards</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);">${accuracy}%</div>
                        <div style="color: var(--text-muted);">Overall Accuracy</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--info);">${totalAttempts}</div>
                        <div style="color: var(--text-muted);">Total Attempts</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 1rem;">Course Breakdown</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${appData.courses.map(course => {
                        const stats = course.stats || { attempts: 0, correct: 0 };
                        const acc = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                        return `
                            <div style="background: var(--bg-card); padding: 1rem 1.5rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">${course.icon}</span>
                                    <span style="font-weight: 600;">${course.name}</span>
                                </div>
                                <div style="display: flex; gap: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                                    <span>${stats.attempts} attempts</span>
                                    <span style="color: ${acc >= 70 ? 'var(--success)' : acc >= 40 ? 'var(--warning)' : 'var(--error)'}; font-weight: 600;">${acc}%</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-secondary" onclick="exportAllData()">üì• Export All Data</button>
                    <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Reset All</button>
                </div>
            `;
        }

        function exportAllData() {
            const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `studyhub-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported!', 'success');
        }

        function resetAllData() {
            if (!confirm('Delete ALL courses and progress? This cannot be undone!')) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('view-study').classList.contains('active')) {
                if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    checkStudyAnswer();
                }
                if (e.key === ' ' && studyState.isChecked && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    renderStudyCard();
                }
                if (e.key === 'Escape' && !studyState.isChecked) {
                    e.preventDefault();
                    showStudyAnswer();
                }
            }
        });

        // ========== INIT ==========
        loadAppData();
        renderCourseGrid();
    </script>
</body>
</html>
